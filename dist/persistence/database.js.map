{"version":3,"sources":["../../src/persistence/database.js"],"names":["pool","Pool","openConnection","Future","encaseP","connect","bind","closeConnection","client","of","release","withConnection_A","$","Any","$DatabaseError","query_A","String","Object","chainRej","S","toDatabaseError","error","reject","DatabaseError","withConnection_I","hook","query_I","sql","params","exec","encaseP2","query","withConnection"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AAEA;AACA;AACA;;AAEA,MAAMA,OAAO,IAAIC,QAAJ,EAAb;;AAEA;AACA,MAAMC,iBAAiBC,YAAOC,OAAP,CAAgBJ,KAAKK,OAAL,CAAaC,IAAb,CAAkBN,IAAlB,CAAhB,CAAvB;;AAEA;AACA,MAAMO,kBAAkBC,UAAUL,YAAOM,EAAP,CAAWD,OAAOE,OAAP,EAAX,CAAlC;;AAIA;AACA;AACA;;AAEA,MAAMC,mBAAmB,CAAEC,OAAEC,GAAJ,EAASD,OAAET,MAAF,CAAUW,qBAAV,EAA2BF,OAAEC,GAA7B,CAAT,CAAzB;;AAEA,MAAME,UAAU,CAAEH,OAAEI,MAAJ,EAAYJ,OAAEC,GAAd,EAAmBD,OAAEK,MAArB,EAA6BL,OAAET,MAAF,CAAUW,qBAAV,EAA2BF,OAAEK,MAA7B,CAA7B,CAAhB;;AAIA;AACA;AACA;;AAEA,MAAM,EAAEC,QAAF,KAAeC,MAArB;;AAEA;AACA,MAAMC,kBAAkBC,SAASlB,YAAOmB,MAAP,CAAeC,qBAAcd,EAAd,CAAkBY,KAAlB,CAAf,CAAjC;;AAEA;AACA,MAAMG,mBAAmBrB,YAAOsB,IAAP,CACvBvB,gBADuB,EAEvBK,eAFuB,CAAzB;;AAKA;AACA,MAAMmB,UAAUC,OAAOC,UAAUpB,UAAU;AACzC,QAAMqB,OAAO1B,YAAO2B,QAAP,CAAiBtB,OAAOuB,KAAP,CAAazB,IAAb,CAAkBE,MAAlB,CAAjB,CAAb;AACA,SAAOU,SAAUE,eAAV,EAA4BS,KAAMF,GAAN,EAAWC,MAAX,CAA5B,CAAP;AACD,CAHD;;AAOA;AACA;AACA;;AAEO,MAAMI,0CACX,cAAK,gBAAL,EACK,EADL,EAEKrB,gBAFL,EAGKa,gBAHL,CADK;;AAMA,MAAMO,wBACX,cAAK,OAAL,EACK,EADL,EAEKhB,OAFL,EAGKW,OAHL,CADK","file":"database.js","sourcesContent":["import { Pool } from 'pg';\r\nimport { $, S, Future, def } from '../fun';\r\nimport { $DatabaseError, DatabaseError } from '../common/types/error';\r\n\r\n/////////////////////////////////////////////////////\r\n//  Connection\r\n/////////////////////////////////////////////////////\r\n\r\nconst pool = new Pool();\r\n\r\n// openConnection :: () -> Future a Client\r\nconst openConnection = Future.encaseP (pool.connect.bind(pool));\r\n\r\n// closeConnection :: Client -> Future a Void\r\nconst closeConnection = client => Future.of (client.release());\r\n\r\n\r\n\r\n/////////////////////////////////////////////////////\r\n//  Algebra\r\n/////////////////////////////////////////////////////\r\n\r\nconst withConnection_A = [ $.Any, $.Future ($DatabaseError) ($.Any) ];\r\n\r\nconst query_A = [ $.String, $.Any, $.Object, $.Future ($DatabaseError) ($.Object) ];\r\n\r\n\r\n\r\n/////////////////////////////////////////////////////\r\n//  Interpreter\r\n/////////////////////////////////////////////////////\r\n\r\nconst { chainRej } = S;\r\n\r\n// toDatabaseError :: Error -> Future DatabaseError a\r\nconst toDatabaseError = error => Future.reject (DatabaseError.of (error));\r\n\r\n// withConnection_I :: Client -> Future a b\r\nconst withConnection_I = Future.hook (\r\n  openConnection(),\r\n  closeConnection\r\n);\r\n\r\n// query_I :: String -> [Any] -> Client -> Future DatabseError QueryResult\r\nconst query_I = sql => params => client => {\r\n  const exec = Future.encaseP2 (client.query.bind(client));\r\n  return chainRej (toDatabaseError) (exec (sql, params));\r\n};\r\n\r\n\r\n\r\n////////////////////////////////////////////////////\r\n//  Export\r\n////////////////////////////////////////////////////\r\n\r\nexport const withConnection = \r\n  def ('withConnection')\r\n      ({})\r\n      (withConnection_A)\r\n      (withConnection_I);\r\n\r\nexport const query = \r\n  def ('query')\r\n      ({})\r\n      (query_A)\r\n      (query_I);"]}